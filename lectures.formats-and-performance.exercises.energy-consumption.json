{"version":3,"kind":"Notebook","sha256":"15f11ae3c641daef4996c37782a03a5c2fa76fd3f08b9b2a4d06110767d18b2f","slug":"lectures.formats-and-performance.exercises.energy-consumption","location":"/lectures/2.4_formats_and_performance/exercises/24_energy_consumption.ipynb","dependencies":[],"frontmatter":{"title":"2.4 Formats and Performance","content_includes_title":true,"kernelspec":{"name":"conda-env-cubes-and-clouds-cubes-and-clouds-new-py","display_name":"cubes-and-clouds-cubes-and-clouds-new","language":"python"},"github":"https://github.com/EO-college/cubes-and-clouds","subject":"Cubes and Clouds learning materials","numbering":{"title":{"offset":3}},"source_url":"https://github.com/EO-college/cubes-and-clouds/blob/main/lectures/2.4_formats_and_performance/exercises/24_energy_consumption.ipynb","edit_url":"https://github.com/EO-college/cubes-and-clouds/edit/main/lectures/2.4_formats_and_performance/exercises/24_energy_consumption.ipynb","thumbnail":"/cubes-and-clouds/build/56b77b9fff7f39fece234cf0910cdb55.svg","exports":[{"format":"ipynb","filename":"24_energy_consumption.ipynb","url":"/cubes-and-clouds/build/24_energy_consumptio-fd03f87cb8565f6e81a5d8fef868fdbb.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{"vscode":{"languageId":"html"}},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"image","style":{"float":"center","marginRight":"10px"},"url":"/cubes-and-clouds/build/56b77b9fff7f39fece234cf0910cdb55.svg","alt":"Cubes & Clouds logo","key":"BPgbuIOms5","urlSource":"https://raw.githubusercontent.com/EO-College/cubes-and-clouds/main/icons/cnc_3icons_process_circle.svg"}],"key":"z6AREX4LCb"}],"key":"qHZR1woYQu"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2.4 Formats and Performance","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dKsZmTaNqf"}],"identifier":"id-2-4-formats-and-performance","label":"2.4 Formats and Performance","html_id":"id-2-4-formats-and-performance","implicit":true,"key":"oceewWLSHo"}],"key":"PdRAjUgMdw"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Usage of resources","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XlYG234QY8"}],"identifier":"usage-of-resources","label":"Usage of resources","html_id":"usage-of-resources","implicit":true,"key":"wyC2pNIVGk"}],"key":"ZhfvLPzPlw"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"When executing code on your local machine or in the cloud, it is important to remember that each operation uses resources.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DMVOUmZqiJ"}],"key":"SeRltOV9lA"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In this section we showcase a python library ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"OSXyXhLm9L"},{"type":"inlineCode","value":"codecarbon","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ehOwKXN6l7"},{"type":"text","value":" that can be used to estimate the energy consumption of your code.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jIpZB008u7"}],"key":"oBamI7ATkv"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Please note that benchmarking systems and profiling code is a complex topic with many variables. These examples merely illustrate very rough estimates.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"obZ13SuWyY"}],"key":"IxkOrnAb61"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"We start by copying the data files needed to complete the exercise using the following shell commands","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Nb9Ob7TZkd"}],"key":"AJuUgtLHBi"}],"key":"krmiP21LM9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"!cp -r ${DATA_PATH%/*/*}/notebooks/cubes-and-clouds/lectures/2.4_formats_and_performance/exercises/assets/codecarbon_utils.py $HOME/\n!cp -r ${DATA_PATH%/*/*}/notebooks/cubes-and-clouds/lectures/2.4_formats_and_performance/exercises/assets $HOME/","key":"tXvnNjuCcP"},{"type":"outputs","id":"Nca8mZ0bIIvKTRjIpcLjs","children":[],"key":"NTL0P2U38r"}],"key":"pFTrjWgBz0"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Start by import all the necessary libraries and utilities.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bmKZgswjXh"}],"key":"baA67H9c8b"}],"key":"SDL0L3bjAS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import random\nimport numpy as np\nimport openeo\nfrom openeo.local import LocalConnection\n\nfrom codecarbon_utils import calculate_emission_equivalents, CustomEmissionsTracker\nlocal_conn = LocalConnection('')","key":"r8yXhde0mw"},{"type":"outputs","id":"E5LzNIwwKv5nZgBhYF14i","children":[],"key":"PLL5wytQlc"}],"key":"iiN8QXwfkv"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Setting up the emission tracker for “offline” use to not interact with the CodeCarbon API.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UTL7jNknUF"}],"key":"Y3oDLlRRc2"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Changing the country code will alter the carbon intensity value used to calculate the emissions.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jhdxvZEV3t"}],"key":"HWm7eKM9ES"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"To learn more about the methodology behind ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"zeee1cIj5e"},{"type":"inlineCode","value":"codecarbon","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"wCn1xgr7Ee"},{"type":"text","value":" see the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"NrMIOQb9b9"},{"type":"link","url":"https://mlco2.github.io/codecarbon/methodology.html#carbon-intensity","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"documentation","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"TnZOpWBOCe"}],"urlSource":"https://mlco2.github.io/codecarbon/methodology.html#carbon-intensity","key":"QUuLAupJSG"},{"type":"text","value":".","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"oNFDOeMYN8"}],"key":"mgMMzNjBaR"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Feel free to change the country code to wherever you are to see how it affects the carbon emissions. ISO codes can be found on ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"TQQBRUJl5t"},{"type":"link","url":"https://en.wikipedia.org/wiki/List_of_ISO_3166_country_codes","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Wikipedia","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"yRaII0kmeA"}],"urlSource":"https://en.wikipedia.org/wiki/List_of_ISO_3166_country_codes","data":{"page":"List_of_ISO_3166_country_codes","wiki":"https://en.wikipedia.org/","lang":"en"},"internal":false,"protocol":"wiki","key":"d5OWZHTg4T"},{"type":"text","value":".","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"l1mhF0oiJ4"}],"key":"m3YpSvtFUT"}],"key":"IF6YwHL80O"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tracker = CustomEmissionsTracker(\n    country_iso_code=\"ITA\",\n    log_level=\"error\",\n    save_to_file=True,\n    output_dir=\"./\",\n)","key":"hMSc20Ot03"},{"type":"outputs","id":"DYJCtIRj7SEuWrfoXhJuJ","children":[],"key":"BkA70JtcAK"}],"key":"j14V1OEDF6"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Simple example","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"f0Vz8yGhQI"}],"identifier":"simple-example","label":"Simple example","html_id":"simple-example","implicit":true,"key":"VWZzjej0U5"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This example performs a simple matrix multiplication using numpy and estimates the energy consumption of the operation.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hcKIggMebG"}],"key":"XvKvrsMSfw"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"As a comparison, we also perform a matrix multiplication using the standard library functionality of Python.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"WB7uFT0P5J"}],"key":"DTDK6vR8J9"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"What you will see is that utilizing high performance libraries like numpy can dramatically increase the efficiency.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"E3UA6emAD3"}],"key":"RcLN5j9Feh"}],"key":"G59P3Wl9d6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tracker.start_experiment(experiment_id=1)\n\ndef matrix_numpy(size: int, iterations: int) -> np.ndarray:\n    \"\"\"\n    Compute the product of a square matrix with itself for a number of iterations using numpy.\n\n    Args:\n        size (int): Size of the matrix (size x size).\n        iterations (int): Number of iterations for matrix multiplication.\n\n    Returns:\n        The result of the matrix product.\n    \"\"\"\n    matrix = np.random.rand(size, size)\n    for _ in range(iterations):\n        matrix = np.dot(matrix, matrix)\n    return matrix\n\nmatrix_numpy(100, 100)\n\ntracker.stop_experiment()","key":"MNBYpUvK8y"},{"type":"outputs","id":"YFoYkV-G-V305nxwkj8Aq","children":[],"key":"POtNTVbDTs"}],"key":"Ep5CnBXNbR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"calculate_emission_equivalents(experiment_id=1)","key":"uBS9L6VeRW"},{"type":"outputs","id":"TLOM_FweA9RjbP_QieC42","children":[],"key":"CfjgF9YOV4"}],"key":"HgVJsSe1MP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tracker.start_experiment(experiment_id=2)\n\ndef matrix_python(size: int, iterations: int) -> list:\n    \"\"\"\n    Compute the product of a square matrix with itself for a number of iterations using pure Python.\n    \n    Args:\n        size (int): Size of the matrix (size x size).\n        iterations (int): Number of iterations for matrix multiplication.\n    \n    Returns:\n        The result of the matrix product.\n    \"\"\"\n\n    matrix = [[random.random() for _ in range(size)] for _ in range(size)]\n\n    for _ in range(iterations):\n        result = [[0] * size for _ in range(size)]\n        for i in range(size):\n            for j in range(size):\n                for k in range(size):\n                    result[i][j] += matrix[i][k] * matrix[k][j]\n        matrix = result\n\n    return matrix\n\nmatrix_python(100, 100)\n\ntracker.stop_experiment()","key":"ydvXooOf2v"},{"type":"outputs","id":"wmnBXBjPWSsPOmCoAMwLL","children":[],"key":"UXr3wvhqoF"}],"key":"hF82aS44v1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"calculate_emission_equivalents(experiment_id=2)","key":"c7hQbScpnr"},{"type":"outputs","id":"syqe2s0DFqP7IMKS77usd","children":[],"key":"yrkwvk4IQJ"}],"key":"qz7H9aDnK4"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Using a real world example","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TGbyAJ2cXj"}],"identifier":"using-a-real-world-example","label":"Using a real world example","html_id":"using-a-real-world-example","implicit":true,"key":"VsC0J3G20k"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In this example, we will use our tracker to estimate the energy consumption of an NDVI workflow from previous exercise.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wbBFT15z1V"}],"key":"rzv7EfBjYc"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"We need to squeeze the code into a single cell to be able to track the energy consumption more easily.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"i1ZLdd2QtS"}],"key":"b8Epdc2wEe"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"For more detailed explanation of the workflow, please refer to the previous exercise.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"lFriCWhd4f"}],"key":"EllqKOSXuZ"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Overview of the workflow:","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"a4VZ07QoBL"}],"key":"lhPcGkdu2U"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":10,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"We select  Sentinel-2 data for a specific area and time frame of 1 year.","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"aFy59NCUsQ"}],"key":"fpYGFqErtw"}],"key":"dWDKKs5SUd"},{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"We perform temporal aggregation to get monthly composites.","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"gH4O5roBju"}],"key":"q1lGzse77f"}],"key":"UPP97NA51x"},{"type":"listItem","spread":true,"position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"We calculate the NDVI for each composite.","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"hvrer6nNW2"}],"key":"WcN09xLUcu"}],"key":"GKIo0MZwgn"}],"key":"pRWWVAihLD"}],"key":"AgHTJYqldx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tracker.start_experiment(experiment_id=3)\n\nurl = \"https://earth-search.aws.element84.com/v1/collections/sentinel-2-l2a\"\n\nspatial_extent = {\"west\": 11.4, \"east\": 11.42, \"south\": 45.5, \"north\": 45.52}\ntemporal_extent = [\"2023-01-01\", \"2023-12-31\"]\nbands = [\"red\",\"nir\"]\n\ns2_cube = local_conn.load_stac(url=url,\n   spatial_extent=spatial_extent,\n   temporal_extent=temporal_extent,\n   bands=bands\n)\n\ns2_monthly_mean = s2_cube.aggregate_temporal_period(period=\"month\", reducer=\"mean\")\n\nred = s2_monthly_mean.band(\"red\")\nnir = s2_monthly_mean.band(\"nir\")\n\nndvi = (nir - red) / (nir + red)\n\nndvi.execute().compute()\n\ntracker.stop_experiment()","key":"hHnAjYrG3n"},{"type":"outputs","id":"WCD3FMruUi40QCBJjZkWI","children":[],"key":"a2uNpCIQ72"}],"key":"GP23dXZToW"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Quiz hint: look carefully energy emission equivalents","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xMuZAxOBz3"}],"key":"eqHVeVbfUR"}],"key":"S1T4s2jtez"}],"key":"VPTwMtmSaN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"calculate_emission_equivalents(experiment_id=3)","key":"SUsLuSwI0K"},{"type":"outputs","id":"U1AMLv_n-SIbHY2cCRAVq","children":[],"key":"uz7b0TBgxO"}],"key":"Hd89lpiL4p"}],"key":"vXoD1Xpna0"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"2.4 Scaling with Pangeo","url":"/lectures/formats-and-performance/exercises/dask","group":"Exercises"},"next":{"title":"3.1 Data Processing","url":"/lectures/data-processing/data-processing","group":"3"}}},"domain":"http://localhost:3000"}