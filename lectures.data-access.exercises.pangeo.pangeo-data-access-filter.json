{"version":3,"kind":"Notebook","sha256":"e7ec79d6e9126243066f10297c9c2802350fad916864e3f1516960bb6e72d4c4","slug":"lectures.data-access.exercises.pangeo.pangeo-data-access-filter","location":"/lectures/2.3_data_access/exercises/pangeo/23_pangeo_data_access_filter.ipynb","dependencies":[],"frontmatter":{"title":"2.3 Data Access and Basic Processing","content_includes_title":true,"kernelspec":{"name":"conda-env-cubes-and-clouds-cubes-and-clouds-pangeo-py","display_name":"cubes-and-clouds-cubes-and-clouds-pangeo","language":"python"},"github":"https://github.com/EO-college/cubes-and-clouds","subject":"Cubes and Clouds learning materials","numbering":{"title":{"offset":3}},"source_url":"https://github.com/EO-college/cubes-and-clouds/blob/main/lectures/2.3_data_access/exercises/pangeo/23_pangeo_data_access_filter.ipynb","edit_url":"https://github.com/EO-college/cubes-and-clouds/edit/main/lectures/2.3_data_access/exercises/pangeo/23_pangeo_data_access_filter.ipynb","thumbnail":"/cubes-and-clouds/build/56b77b9fff7f39fece234cf0910cdb55.svg","exports":[{"format":"ipynb","filename":"23_pangeo_data_access_filter.ipynb","url":"/cubes-and-clouds/build/23_pangeo_data_acces-18aee486a4cdf2709435073ccb491327.ipynb"}]},"widgets":{"application/vnd.jupyter.widget-state+json":{"state":{},"version_major":2,"version_minor":0}},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","children":[{"type":"image","style":{"float":"center","marginRight":"10px","marginLeft":"10px","maxHeight":"250px"},"url":"/cubes-and-clouds/build/56b77b9fff7f39fece234cf0910cdb55.svg","alt":"Cubes & Clouds logo","key":"rKVi6Upj0j","urlSource":"https://raw.githubusercontent.com/EO-College/cubes-and-clouds/main/icons/cnc_3icons_process_circle.svg"}],"key":"ccrrC7slPh"}],"key":"w6cp7h3Uhf"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2.3 Data Access and Basic Processing","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"p6WjmkFxVq"}],"identifier":"id-2-3-data-access-and-basic-processing","label":"2.3 Data Access and Basic Processing","html_id":"id-2-3-data-access-and-basic-processing","implicit":true,"key":"KwFmhwdQiy"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"image","style":{"float":"center","marginRight":"10px","maxHeight":"80px"},"url":"/cubes-and-clouds/build/0f8adf2e4ec0feb14584840545a0ae3a.png","alt":"Pangeo logo","key":"rcE9uxpdhW","urlSource":"https://raw.githubusercontent.com/pangeo-data/pangeo.io/refs/heads/main/public/Pangeo-assets/pangeo_logo.png"}],"key":"SQqXByY6qM"},{"type":"heading","depth":2,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Filter Operators with Pangeo ecosystem","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"jkRwa6DjIZ"}],"identifier":"filter-operators-with-pangeo-ecosystem","label":"Filter Operators with Pangeo ecosystem","html_id":"filter-operators-with-pangeo-ecosystem","implicit":true,"key":"fkkK6VYrD1"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"When interacting with large data collections, it is necessary to keep in mind that it’s not possible to load everything!","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"pHHKtoWXH5"}],"key":"gU8EC2c3Mk"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Therefore, we always have to define our requirements in advance and apply them to the data using filter operators.","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"DJV9Qqkbr9"}],"key":"dyMeWosq9x"},{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"Let’s start again with the same sample data from the Sentinel-2 STAC Collection with an additional filter.","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"eG9RFn2D3f"}],"key":"QPBXmgnHsf"}],"key":"xdqm4XGHRL"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Properties Filter","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NsgOCz8UTk"}],"identifier":"properties-filter","label":"Properties Filter","html_id":"properties-filter","implicit":true,"key":"eHcQAiAXxX"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"When working with optical data like Sentinel-2, most of the times we would like to discard cloudy acquisitions as soon as possible.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"oLRLspiDcg"}],"key":"ZfgrWcG0mS"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"We can do it using a property filter: in this case we want to keep only the acquisitions with less than 50% cloud coverage.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Yph8ToMbWN"}],"key":"Uyeb5HJ2PH"}],"key":"S1luZX35E4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import pystac_client\nimport stackstac\nimport numpy as np\nfrom pyproj import Proj","key":"b8g90L2yVG"},{"type":"outputs","id":"yqi-nZVdPs0LcJ1STUk1z","children":[],"key":"mDnzU2v0Bt"}],"key":"j9GSH0V89v"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"properties = {\"eo:cloud_cover\": dict(lt=50)}","key":"etsS7RrulJ"},{"type":"outputs","id":"0PaWGXXWgM6aw8fLhCKkt","children":[],"key":"DHmzGyulfq"}],"key":"NFzDNo5CUz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"spatial_extent = [11.1, 46.1, 11.5, 46.5]\ntemporal_extent = [\"2024-01-01T00:00:00Z\",\"2024-10-30T00:00:00Z\"]\nURL = \"https://earth-search.aws.element84.com/v1\"\ncatalog = pystac_client.Client.open(URL)\nitems = catalog.search(\n    bbox=spatial_extent,\n    datetime=temporal_extent,\n    collections=[\"sentinel-2-l2a\"],\n    query=properties\n).item_collection()\n\ndatacube = stackstac.stack(items,\n                     bounds_latlon=spatial_extent,\n)\ndatacube","key":"nhbGJPJbpA"},{"type":"outputs","id":"PQksDU2-PqCFw0NFy8r8s","children":[],"key":"V5fYaPkZmW"}],"key":"JTpBIEY1CQ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Temporal Filter","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IvpEY9J1TA"}],"identifier":"temporal-filter","label":"Temporal Filter","html_id":"temporal-filter","implicit":true,"key":"imTIaVjEdi"}],"key":"h2F97lWfHl"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"To filter along time the data collection with Pangeo Xarray, we create a binary mask combining two conditions, passing it to the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lVADiqZBp1"},{"type":"inlineCode","value":"where","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zRINJCcr5N"},{"type":"text","value":" method from Xarray. Remember to set ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nyTgV8D5PH"},{"type":"inlineCode","value":"drop=True","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qzAc3u9dDE"},{"type":"text","value":" to discard the dates outside the selected period.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GnXZnAEksE"}],"key":"EgKk3uLwiz"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Note","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GgEVxQhfBv"}],"key":"QGGMog1GOw"},{"type":"text","value":": We cannot use the sel method to select a slice to filter on the time dimension since the times are not equally spaced.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"lGVaYtpg10"}],"key":"xJ4MyaCVh9"}],"key":"Nnu2ulRfuz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"temporal_slice = datacube.where((datacube.time>=np.datetime64(\"2024-05-10T00:00:00\")) &\n                                (datacube.time<=np.datetime64(\"2024-06-30T00:00:00\")),\n                                drop=True)\ntemporal_slice","key":"A0wljZYbtL"},{"type":"outputs","id":"164X8gQD2Ud9uYv2LYKgM","children":[],"key":"m54rBGRbBg"}],"key":"iMqLz2BwH2"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"After running the previous cell, it is visible that the result has less elements (or labels) in the temporal dimension ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FCKgpKyjSj"},{"type":"inlineCode","value":"time","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dW2tVeHD6z"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hIbNK3LtyC"}],"key":"Z1GQpZJPGH"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Additionally, the size of the selected data reduced a lot.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"KJszlRWXsu"}],"key":"V2PsG8Clrg"}],"key":"f70ZzMRIP5"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Quiz hint: look carefully at the dimensions of the resulting datacube!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mgAlt4r3mK"}],"key":"IkIo5PgmWb"}],"key":"KZ6SulHyYu"}],"key":"ti1pc98O12"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Spatial Filter","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vChQ9Mz3UM"}],"identifier":"spatial-filter","label":"Spatial Filter","html_id":"spatial-filter","implicit":true,"key":"JGMqJ3p05t"}],"key":"V2CsB9LCuf"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"To slice along the spatial dimensions the data collection with Pangeo, we can use ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dPj1Nv5dCX"},{"type":"inlineCode","value":"sel","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ONJ3KvnKHz"},{"type":"text","value":" method with a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BQwgZ8u5Xe"},{"type":"inlineCode","value":"slice","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yOejPUr1eF"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"J3eHs9xYBj"}],"key":"IQfBpGBVFa"}],"key":"xo6ybjxsUm"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s get the spatial extent expressed in the Coordinate Reference System of the datacube. We need to project latitudes, longitudes to the data cube CRS.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"L1XfCuy801"}],"key":"fDQnscP93k"}],"key":"Bonym7K39d"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"west = 11.259613; east = 11.406212\nsouth = 46.461019; north = 46.522237\nprojection = Proj(temporal_slice.attrs[\"crs\"])\nx_ws, y_ws = projection(west, south)\nx_wn, y_wn = projection(west, north)\nx_es, y_es = projection(east, south)\nx_en, y_en = projection(east, north)\nxmax = max(x_ws, x_wn, x_es, x_en)\nxmin = min(x_ws, x_wn, x_es, x_en)\nymax = max(y_ws, y_wn, y_es, y_en)\nymin = min(y_ws, y_wn, y_es, y_en)\nprint(xmin, xmax, ymin, ymax)","key":"OSiAbnguG9"},{"type":"outputs","id":"rl6LhvRxAY1QqnROPMHdB","children":[],"key":"Ty9CWgFQIP"}],"key":"zfn9lfQWP0"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pQuk7jYKG4"},{"type":"inlineCode","value":"sel","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"z0U9klNjG6"},{"type":"text","value":" method with ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tYrekuMFgx"},{"type":"inlineCode","value":"slice","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TaFmX4WXyn"},{"type":"text","value":" is used with a set of coordinates.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GbL6UM9d22"}],"key":"DMUgFP4Rwc"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Note","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NMZB2TOETl"}],"key":"r2jvzq90dP"},{"type":"text","value":": The order of the interval in the slice needs to be expressed in the same order as the corresponding coordinate.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WKvnk1KsF3"}],"key":"MqseHKAGms"}],"key":"QKOumNuw57"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"spatial_slice = temporal_slice.sel(x=slice(xmin,xmax), y = slice(ymax,ymin))\nspatial_slice","key":"XumDsGqVsq"},{"type":"outputs","id":"ZVMonIX9Q_escu9SUwPx-","children":[],"key":"HGN3GzLffs"}],"key":"QlN5Ow0dFQ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Quiz hint: look carefully at the dimensions of the loaded datacube!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Zd5BsWPQda"}],"key":"cJ6UqbihPQ"}],"key":"f7m1hdg5lk"}],"key":"w0Cndu8iHh"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Bands Filter","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SDA8R39wOc"}],"identifier":"bands-filter","label":"Bands Filter","html_id":"bands-filter","implicit":true,"key":"svkVBxAA2U"}],"key":"rS8yg9A4ac"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"To slice along the bands dimension, keeping only the necessary bands, we can use the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"V2W6yWLgQH"},{"type":"inlineCode","value":"sel","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GvEdz8cZdr"},{"type":"text","value":" method and ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mbKIZsZztY"},{"type":"inlineCode","value":"isin","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xRHAEyC6m7"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"plh0akfWH1"}],"key":"F0a4Fez1RX"}],"key":"kG5XQwJjE5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"bands = [\"red\", \"green\", \"blue\"]\nbands_slice = spatial_slice.sel(band=spatial_slice.band.isin(bands))\nbands_slice","key":"qlnGa1MIay"},{"type":"outputs","id":"ME5FZX1b4GH5JSa7F8-f0","children":[],"key":"H8Y7QgECte"}],"key":"hRLPQmfruL"}],"key":"growjMyxqu"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"2.3 Data Access and Basic Processing","url":"/lectures/data-access/exercises/pangeo/pangeo-data-access-reduce","group":"Data access with pangeo"},"next":{"title":"2.3 Data Access and Basic Processing","url":"/lectures/data-access/exercises/pangeo/pangeo-data-access-resample","group":"Data access with pangeo"}}},"domain":"http://localhost:3000"}