{"version":3,"kind":"Notebook","sha256":"3ed01287a362a85fba5ccd497923bc88e50715efce81e533e267e7b50e64d976","slug":"lectures.data-access.exercises.openeo.openeo-data-access-aggregate","location":"/lectures/2.3_data_access/exercises/openeo/23_openeo_data_access_aggregate.ipynb","dependencies":[],"frontmatter":{"title":"2.3 Data Access and Basic Processing","content_includes_title":true,"kernelspec":{"name":"conda-env-cubes-and-clouds-cubes-and-clouds-cubes_and_clouds_update-py","display_name":"cubes-and-clouds-cubes-and-clouds-cubes_and_clouds_update","language":"python"},"github":"https://github.com/EO-college/cubes-and-clouds","subject":"Cubes and Clouds learning materials","numbering":{"title":{"offset":3}},"source_url":"https://github.com/EO-college/cubes-and-clouds/blob/main/lectures/2.3_data_access/exercises/openeo/23_openeo_data_access_aggregate.ipynb","edit_url":"https://github.com/EO-college/cubes-and-clouds/edit/main/lectures/2.3_data_access/exercises/openeo/23_openeo_data_access_aggregate.ipynb","thumbnail":"/cubes-and-clouds/build/56b77b9fff7f39fece234cf0910cdb55.svg","exports":[{"format":"ipynb","filename":"23_openeo_data_access_aggregate.ipynb","url":"/cubes-and-clouds/build/23_openeo_data_acces-407ba99083fc4dd3c3d2fd11a33cfb26.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","children":[{"type":"image","style":{"float":"center","marginRight":"10px","marginLeft":"10px","maxHeight":"250px"},"url":"/cubes-and-clouds/build/56b77b9fff7f39fece234cf0910cdb55.svg","alt":"Cubes & Clouds logo","key":"O1zsMolbLD","urlSource":"https://raw.githubusercontent.com/EO-College/cubes-and-clouds/main/icons/cnc_3icons_process_circle.svg"}],"key":"JRQARGfJQj"}],"key":"mQb8uG9P4c"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2.3 Data Access and Basic Processing","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hzyqegeZNO"}],"identifier":"id-2-3-data-access-and-basic-processing","label":"2.3 Data Access and Basic Processing","html_id":"id-2-3-data-access-and-basic-processing","implicit":true,"key":"TDNPvSB9oq"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"image","style":{"float":"center","marginRight":"10px","maxHeight":"100px"},"url":"/cubes-and-clouds/build/7d92286654718ed077e8b148b8c89bdd.png","alt":"openEO logo","key":"D3fKjGqhC0","urlSource":"https://openeo.org/images/openeo_logo.png"}],"key":"E2b7x740tM"},{"type":"heading","depth":2,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Aggregate Operators with openEO","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"tDa45iJXAz"}],"identifier":"aggregate-operators-with-openeo","label":"Aggregate Operators with openEO","html_id":"aggregate-operators-with-openeo","implicit":true,"key":"YBlhOR56bA"}],"key":"xCkZQH2Dvf"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"aggregate_temporal_period","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BCS9LqO6ie"},{"type":"text","value":": temporal aggregation with predefined intervals","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"T5vs7O0dsj"}],"identifier":"aggregate-temporal-period-temporal-aggregation-with-predefined-intervals","label":"aggregate_temporal_period: temporal aggregation with predefined intervals","html_id":"aggregate-temporal-period-temporal-aggregation-with-predefined-intervals","implicit":true,"key":"EQxEXmbQzN"}],"key":"eTXzXu4rr8"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Start importing the necessary libraries and initialize a local connection for Client-Side Processing.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"s3Ym2nNeVq"}],"key":"T8keQHI9F7"}],"key":"jzfCboe5gT"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import openeo\nfrom openeo.local import LocalConnection\nlocal_conn = LocalConnection('')","visibility":"show","key":"SQ2L94Cjzc"},{"type":"outputs","id":"x2TGwWWOFLNQDCICSVrFo","children":[],"visibility":"show","key":"Bfj1z3dPJI"}],"visibility":"show","key":"ZMQjsBBxhS"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create the starting Sentinel-2 datacube:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Rqg2qvu9pU"}],"key":"BZv0X7Gi6M"}],"key":"qjR6I6FDN5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"url = \"https://earth-search.aws.element84.com/v1/collections/sentinel-2-l2a\"\n\nspatial_extent = {\"west\": 11.4, \"east\": 11.42, \"south\": 45.5, \"north\": 45.52}\ntemporal_extent = [\"2020-01-01\", \"2020-12-31\"]\nbands = [\"red\",\"green\",\"blue\"]\nproperties = {\"eo:cloud_cover\": dict(lt=50)}\n\ns2_cube = local_conn.load_stac(url=url,\n   spatial_extent=spatial_extent,\n   temporal_extent=temporal_extent,\n   bands=bands,\n   properties=properties\n)\ns2_cube.execute()","key":"xFjdoXjVFs"},{"type":"outputs","id":"lbQ4tdFW7QKMELWjmXDXI","children":[],"key":"j9PtivRZQZ"}],"key":"MAMG7v8N5s"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We might be interested in aggregating our data over periods like week, month, year etc., defining what operation to use to combine the data available in the chosen period.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"c3adcLozES"}],"key":"RA9w2kPpGz"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"O35sjW28aX"},{"type":"inlineCode","value":"aggregate_temporal_period","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hjrIClPaWk"},{"type":"text","value":" we can achieve this easily:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"LcCDUP7jf8"}],"key":"us2nAMzhbX"}],"key":"QCaYAvRwyE"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"s2_monthly_min = s2_cube.aggregate_temporal_period(period=\"month\",reducer=\"min\")\ns2_monthly_min","visibility":"show","key":"LIsJbwOiNK"},{"type":"outputs","id":"PSt_ugaFvTr_SM5y8Dg-w","children":[],"visibility":"show","key":"o3JZrP6y1U"}],"visibility":"show","key":"IpIsG3zqAc"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Check what happens to the datacube inspecting the resulting xArray object. Now the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mXulMaRbcC"},{"type":"inlineCode","value":"time","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aVdMSF0CTT"},{"type":"text","value":" dimension has 12 labels, one for each month.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dDHKoS3tYB"}],"key":"DQEqO37ToY"}],"key":"XAzRKc2fn3"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"s2_monthly_min.execute()","visibility":"show","key":"hUIelqocUH"},{"type":"outputs","id":"9568ymhOARclXTNxCNqI1","children":[],"visibility":"show","key":"Rmr4ckmb30"}],"visibility":"show","key":"WqeYhWNa1A"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"aggregate_spatial","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"z2Vi1ZaL14"},{"type":"text","value":": spatial aggregation with geometries","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uvFcB6YyWj"}],"identifier":"aggregate-spatial-spatial-aggregation-with-geometries","label":"aggregate_spatial: spatial aggregation with geometries","html_id":"aggregate-spatial-spatial-aggregation-with-geometries","implicit":true,"key":"WkX37RUYvT"}],"key":"w2TIa0omo3"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Before performing the operation on the satellite data with openEO, we need to get a vector data to be used in our workflow.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dpyV4aKoam"}],"key":"zj9PMWSSDr"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We will use the city boundaries of Bolzano (Italy) to perform an aggregation of the pixels within the specified geometry.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jgmCrP4Z3m"}],"key":"o0HZ64y2H7"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The geometry will be loaded from a public geoJSON file containing the boundaries of all the italian municipalities.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"MmgU0t9owM"}],"key":"tpnxsrQiEY"}],"visibility":"show","key":"i77SlDb0b4"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import geopandas as gpd\n\nitalian_municipalities = gpd.read_file(\"https://raw.githubusercontent.com/openpolis/geojson-italy/refs/heads/master/comuni.geojson\")\nitalian_municipalities.head()","visibility":"show","key":"ytpbrIcZVu"},{"type":"outputs","id":"VYVO4V0OtUY_Jy3C5SdJX","children":[],"visibility":"show","key":"HECXKyQAIL"}],"visibility":"show","key":"ZJYQmafP5c"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We select the row corresponding to Bolzano and plot it with a base layer:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Wne7B3OtU8"}],"key":"UmfsM8EFoV"}],"key":"cAoxZ4ILrm"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import contextily as cx\n\nbz_geom = italian_municipalities.loc[italian_municipalities[\"name\"] == \"Bolzano/Bozen\"]\n\nbz_wm = bz_geom.to_crs(epsg=3857)\nax = bz_wm.plot(figsize=(10, 10), alpha=0.5, edgecolor=\"k\")\ncx.add_basemap(ax)","visibility":"show","key":"FMK8ROiTBp"},{"type":"outputs","id":"pxNud4fHGv5LOsQ--ERMG","children":[],"visibility":"show","key":"G9rHtuB85o"}],"visibility":"show","key":"hOFssRT9KN"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We can now build our workflow with openEO, starting to load some Sentinel-2 data from STAC as before:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tpcdcva9yN"}],"key":"QKA65eD0xY"}],"key":"Owdm0PNk1h"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"url = \"https://earth-search.aws.element84.com/v1/collections/sentinel-2-l2a\"\n\nspatial_extent = {\"west\": 11.25, \"east\": 11.44, \"south\": 46.4, \"north\": 46.6}\ntemporal_extent = [\"2020-01-01\", \"2020-12-31\"]\nbands = [\"red\"]\nproperties = {\"eo:cloud_cover\": dict(lt=15),\n             \"earthsearch:boa_offset_applied\": dict(eq=True)}\n\ns2_cube = local_conn.load_stac(url=url,\n   spatial_extent=spatial_extent,\n   temporal_extent=temporal_extent,\n   bands=bands,\n   properties=properties\n)","visibility":"show","key":"mNaRfUX7jV"},{"type":"outputs","id":"qCo6ak7_vaDFGZh2ovCBi","children":[],"visibility":"show","key":"fjyIk9LmRm"}],"visibility":"show","key":"gjGSW2lGn6"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now we call the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DAVENa9aHI"},{"type":"inlineCode","value":"aggregate_spatial","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xswiFbvbgI"},{"type":"text","value":" process and compute the average over the Sentinel-2 pixels inside the city.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ML9Z2s392b"}],"key":"kwcfr6vrGZ"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Running this cell may take up to 2 minutes","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"drTIJyviAp"}],"key":"GpeeyJj14x"}],"key":"D36XojW8FP"}],"key":"j9nwcr2mNz"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"from joblib import parallel_backend\n\nwith parallel_backend(\"threading\"):\n    bolzano_mean_xr = s2_cube.aggregate_spatial(\n        geometries=bz_geom.geometry.values[0].geoms[0],\n        reducer=\"mean\"\n    ).execute()\n","visibility":"show","key":"fP7SCO5dRd"},{"type":"outputs","id":"qjK2f7mpqG4KsU0_j9H4H","children":[],"visibility":"show","key":"Yf0sBwLyqG"}],"visibility":"show","key":"XA19Jns4Hg"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Finally, we can plot the resulting time series of values for a sample band:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"I9rMZ3XFoo"}],"key":"GrCw2Lwpd1"}],"visibility":"show","key":"KIbtZDD3t1"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"bolzano_mean_xr[:,:,0].plot()","visibility":"show","key":"eayVmzAg39"},{"type":"outputs","id":"mHCVYkTwLBQIb13eaodkX","children":[],"visibility":"show","key":"Xi6hPVd3Zw"}],"visibility":"show","key":"hnu8GzYO3F"}],"key":"yqIe583zaS"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"2.3 Data Access and Basic Processing","url":"/lectures/data-access/exercises/openeo/openeo-data-access-resample","group":"Data access with OpenEO"},"next":{"title":"2.3 Data Access and Basic Processing","url":"/lectures/data-access/exercises/openeo/openeo-data-access-apply","group":"Data access with OpenEO"}}},"domain":"http://localhost:3000"}